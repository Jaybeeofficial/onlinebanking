<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Chat Panel</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
<style>
  body { font-family: Arial; margin:0; padding:0; height:100vh; display:flex; }
  /* Sidebar */
  .sidebar { width:250px; background:#007BFF; color:#fff; display:flex; flex-direction:column; }
  .sidebar h2 { text-align:center; padding:20px 0; margin:0; border-bottom:1px solid rgba(255,255,255,0.3); }
  .chat-list { flex:1; overflow-y:auto; padding:10px; }
  .chat-list .chat-item { background: rgba(255,255,255,0.2); padding:10px; border-radius:8px; margin-bottom:8px; cursor:pointer; }

  /* Chat Window */
  .chat-window { flex:1; display:flex; flex-direction:column; border-left:1px solid #ccc; }
  .chat-header { background:#f1f1f1; padding:10px; font-weight:bold; }
  .chat-messages { flex:1; padding:10px; overflow-y:auto; background:#fafafa; display:flex; flex-direction:column; }
  .chat-messages .user { background:#007BFF; color:#fff; padding:6px 10px; border-radius:8px; max-width:70%; margin:6px 0; align-self:flex-start; }
  .chat-messages .admin { background:#e0e0e0; color:#000; padding:6px 10px; border-radius:8px; max-width:70%; margin:6px 0; align-self:flex-end; }
  .chat-form { display:flex; padding:10px; border-top:1px solid #ccc; }
  .chat-form input { flex:1; padding:8px; border:1px solid #ccc; border-radius:6px; }
  .chat-form button { padding:8px 12px; margin-left:8px; border:none; background:#007BFF; color:#fff; border-radius:6px; cursor:pointer; }

  /* Admin Login Overlay */
  .login-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index:9999; }
  .login-card { background:#fff; padding:30px; border-radius:10px; width:300px; box-shadow:0 4px 12px rgba(0,0,0,0.3); }
  .login-card input { width:100%; padding:10px; margin:10px 0; border:1px solid #ccc; border-radius:6px; }
  .login-card button { width:100%; padding:10px; background:#007BFF; color:#fff; border:none; border-radius:6px; cursor:pointer; }
  .login-card p { color:red; margin-top:5px; text-align:center; }
  @media (max-width: 900px) {
    body {
      flex-direction: column;
    }
    .sidebar {
      width: 100%;
      order: 2;
    }
    .chat-window {
      width: 100%;
      order: 1;
      border-left: none;
      border-top: 1px solid #ccc;
      min-height: 50vh;
    }
    .chat-form input {
      flex: 1 1 100%;
      margin-bottom: 6px;
    }
    .chat-form button {
      flex: 1 1 100%;
      margin-left: 0;
    }
  }
</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <h2>Active Chats</h2>
  <div class="chat-list" id="chatList">Loading chats...</div>
</div>

<!-- Chat Window -->
<div class="chat-window">
  <div class="chat-header" id="chatHeader">Select a user to start chat</div>
  <div class="chat-messages" id="chatMessages"></div>
  <form class="chat-form" id="chatForm">
    <input type="text" id="chatInput" placeholder="Type message..." autocomplete="off"/>
    <button type="submit">Send</button>
  </form>
</div>

<!-- Admin Login Overlay -->
<div class="login-overlay" id="adminLoginOverlay">
  <div class="login-card">
    <h2>Admin Login</h2>
    <input type="email" id="adminEmail" placeholder="Email" required>
    <input type="password" id="adminPassword" placeholder="Password" required>
    <button id="adminLoginBtn">Login</button>
    <p id="errorMsg"></p>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
 // ---------------- Firebase Init ----------------
const firebaseConfig = {
  apiKey: "AIzaSyBR9H69WILmZ0JmlDopihAk_zhEtDpIsFw",
  authDomain: "onlinebanking-347dd.firebaseapp.com",
  projectId: "onlinebanking-347dd",
  storageBucket: "onlinebanking-347dd.appspot.com",
  messagingSenderId: "1047597422756",
  appId: "1:1047597422756:web:2b08b2ca528cfd3e4cee31"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

// ---------------- Elements ----------------
const adminLoginOverlay = document.getElementById("adminLoginOverlay");
const adminEmail = document.getElementById("adminEmail");
const adminPassword = document.getElementById("adminPassword");
const adminLoginBtn = document.getElementById("adminLoginBtn");
const errorMsg = document.getElementById("errorMsg");

const chatListEl = document.getElementById("chatList");
const chatMessagesEl = document.getElementById("chatMessages");
const chatHeader = document.getElementById("chatHeader");
const chatForm = document.getElementById("chatForm");
const chatInput = document.getElementById("chatInput");

const admins = ["admin@yourbank.com"]; // Authorized admin
const selectedChatId = "chat_user1"; // Single user chat

// ---------------- Admin Login ----------------
adminLoginBtn.onclick = () => {
  const email = adminEmail.value.trim();
  const password = adminPassword.value.trim();
  auth.signInWithEmailAndPassword(email, password)
    .then(({ user }) => {
      if (!admins.includes(user.email)) {
        errorMsg.textContent = "Unauthorized admin.";
        auth.signOut();
        return;
      }
      adminLoginOverlay.style.display = "none";
      initChatPanel();
    })
    .catch(err => errorMsg.textContent = err.message);
};

// Keep admin logged in
auth.onAuthStateChanged(user => {
  if (user && admins.includes(user.email)) {
    adminLoginOverlay.style.display = "none";
    initChatPanel();
  } else {
    adminLoginOverlay.style.display = "flex";
  }
});

// ---------------- Admin Chat Panel ----------------
function initChatPanel() {
  chatHeader.textContent = "Chat with User: Account Owner";

  const chatRef = db.collection("chats").doc(selectedChatId);
  chatRef.set({}, { merge: true });

  const messagesRef = chatRef.collection("messages");
  messagesRef.limit(1).get().then(snapshot => {
    if (snapshot.empty) {
      messagesRef.add({
        sender: "system",
        message: "Chat initialized",
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
  });

  // Listen for messages
  messagesRef.orderBy("timestamp").onSnapshot(snapshot => {
    chatMessagesEl.innerHTML = "";
    snapshot.forEach(doc => {
      const msg = doc.data();
      const div = document.createElement("div");
      div.textContent = msg.message;

      if(msg.sender === "admin") div.className = "admin";
      else if(msg.sender === "user") div.className = "user";
      else div.className = "system";

      // Styles
      div.style.padding = "6px 10px";
      div.style.borderRadius = "8px";
      div.style.margin = "4px 0";
      div.style.maxWidth = "70%";
      div.style.alignSelf = msg.sender === "admin" ? "flex-end" : "flex-start";
      div.style.background = msg.sender === "admin" ? "#e0e0e0" : (msg.sender === "user" ? "#007BFF" : "#ccc");
      div.style.color = msg.sender === "admin" ? "#000" : "#fff";

      chatMessagesEl.appendChild(div);
    });
    chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
  });

  // Send message
  chatForm.onsubmit = e => {
    e.preventDefault();
    const message = chatInput.value.trim();
    if(!message) return;

    messagesRef.add({
      sender: "admin",
      message,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    chatInput.value = "";
  };
}


</script>
</body>
</html>
